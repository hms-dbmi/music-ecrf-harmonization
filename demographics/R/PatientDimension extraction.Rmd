---
title: "Extraction from PatientDimension eCRF"
date: "`r Sys.Date()`"
author: Pierre
output:
---

```{r}
library( dplyr )
library(lubridate)
```



Downloading the Patient Dimension table and extraction of the desired values (birth date / age / language / zip code / races / patient num)

```{r}

Patient_dimension_table <- read.csv("../local_ref/music_patient_dimension.csv")


out <-Patient_dimension_table %>%
  select(PATIENT_NUM, AGE_IN_YEARS_NUM, BIRTH_DATE, LANGUAGE_CD, RACE_CD, ZIP_CD)


```


Loading the dictionary relevant to the demographic eCRF

```{r}
data_dictionary <- read.csv("../../common_ref/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv")%>%
  filter(Form.Name=="demographics")
```


Loading the county-state-zipcode datatable (https://github.com/scpike/us-state-county-zip)

```{r}
zip_table <- read_csv('https://raw.githubusercontent.com/scpike/us-state-county-zip/master/geo-data.csv')
```


Creation of the demographic eCRF table to fill-in. The column name are from the dictionnary and the number of row matches the number of rows of the patient_dimension table

```{r}

eCRF_table <- data.frame(matrix(ncol =36, nrow = nrow(Patient_dimension_table)))
name <- c("Patient_id", "dob", "lt_1_admit", "premature", "wks_gest_birth", "corrected_gest_age", "ethnicity", "language","langauge_other",
       "white", "black", "indian", "alaskan_native", "native_hawaiian", "pacific_islander", "asian", "race_other", "race_other_list","race_refused_unknown",
       "country", "country_other", "zipcodeus", "postalcode_canada", "usstate", "canadaprovince", "residence_other", "county", "census","censusdt",
       "censustract", "censusblock", "insurance", "insurance_primary", "other_studies", "other_studies_list","other_studies_other"
       )
colnames(eCRF_table) <- name


```



###ZIP CODE###
Data dictionary: For US residents, please collect the 5-digit zip code
The zip code were originally 4 digits. So a 0 is added at the beginning when the zipcode is 4 digit. If it is already a 5 digit zipcode it will remain the same

```{r}


format_zipcode <- function(zipcode){
  if(nchar(zipcode) == 4){
    return(paste0(0, zipcode))
  }else{
    return(zipcode)
  }
}

out <- out %>%
  mutate(zipcodeus = format_zipcode(ZIP_CD)) %>%
  select(-ZIP_CD)

```


###Country###
Country of residence: 1, US | 2, Canada | 3, Other
If there is a zipcode, it means that the patient is a US resident. So we are looking into the eCRF zipcode column. If there is a value, country should be 1.
```{r}

identify_country <- function(zipcode) {
  if (is.null(zipcode)) {
    return('')
  } else {
    return(1)
  }
}

out <- out %>% 
  mutate(country = identify_country(zipcodeus))

```

###US state and County###

Identify state abbreviation and county based on zipcode

```{r}

out <- out %>%
  left_join(zip_table %>%
              select(state_abbr, county, zipcode),
            by = c('zipcodeus' = 'zipcode')) %>%
  mutate(usstate = state_abbr)  %>%
  select(-state_abbr)

```


###Language###
Data dictionary (language): 1, English | 2, Spanish | 3, Both English and Spanish | 4, Other | 99, Decline to answer
Data dictionary (language_other): If other language, please specify (if [language] = "4")

```{r}
## not sure how case 3 (both english and spanish) or case 99 (decline to answer) would appear in the EHR
# should check with other sites and as more patients are added
categorize_language <- function(language){
  language <- tolower(language)
  ifelse (language == 'english', 1, 
          ifelse(language == 'spanish', 2, 4)
  )
}

identify_other_language <- function(language){
  language <- tolower(language)
  ifelse(!language %in% c('english', 'spanish'), language, '')
}

out <- out %>%
  mutate(language = categorize_language(LANGUAGE_CD),
         language_other = identify_other_language(LANGUAGE_CD))


```


###Race### 
Data dictionary (white, black, indian, alaskan_native, pacific_islander, asian, race_other, race_refused_unknown): 1, Yes | 0, No
Data dictionary (race_other_list): Please list other race

Note that in BCH, there is no distinction between American Indian or Alaskan Native. They will be treated as other. 
Other will include those which are explicitly listed as other and also those which do not fit the ecrf categories.

```{r}

identify_other_race <- function(race_other, race_cd){
  ifelse(race_other, race_cd, '')
}

# load manually curated race mapping, this will need to be created for each site based on their data
race_mapping <- read.csv("../data/Race_mapping.csv") %>%
  separate_rows(bch_race, sep = ',')

out <- out %>%
  left_join(race_mapping, by = c('RACE_CD' = 'bch_race')) %>%
  mutate(race_yn = 1) %>%
  pivot_wider(names_from = ecrf_race,
              values_from = race_yn,
              values_fill = 0) %>%
  mutate(race_other_list = identify_other_race(race_other, RACE_CD)) %>%
  select(-RACE_CD)


```


# DOB
Data dictionary (dob): mm-dd-yyyy or enter "-99" if unknown
```{r}
out <- out %>%
  mutate(dob = format(dmy_hms(BIRTH_DATE), '%m/%d/%Y'))

```

# Missing vars
```{r}
data_dictionary$Variable...Field.Name[which(!data_dictionary$Variable...Field.Name %in% colnames(out))]

```


Write output
```{r}

# map BCH ids to MUSIC IDs for REDCAP
id_mapping <- read.csv('../../local_ref/music_id_mapping.csv')
out <- left_join(out, id_mapping %>% select(PATIENT_NUM, MUSIC_ID)) %>% 
  ungroup() %>% 
  select(-PATIENT_NUM, -AGE_IN_YEARS_NUM, -BIRTH_DATE, -LANGUAGE_CD, -language_other) %>%
  rename(record_id = MUSIC_ID) %>%
  mutate(redcap_event_name = 'day_1_arm_1') %>%
  filter(!is.na(record_id)) %>% # remove patients who did not have a music id mapping
  relocate(record_id, redcap_event_name) 

# write output with patient IDs included
write.csv(out, '../local_ref/redcap_output_demographics.csv', row.names = FALSE, na = '')
#write.csv(out %>% select(-colnames(out)[!colnames(out) %in% data_dictionary$Variable...Field.Name]), "../local_ref/redcap_output_demographics.csv", row.names = FALSE)
```

