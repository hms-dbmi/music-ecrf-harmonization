---
title: "Extraction from PatientDimension eCRF"
date: "`r Sys.Date()`"
author: Pierre
output:
---

```{r}
library( dplyr )
```



Downloading the Patient Dimension table and extraction of the desired values (birth date / age / language / zip code / races / patient num)

```{r}

Patient_dimension_table <- read.csv("../local_ref/music_patient_dimension.csv")


out <-Patient_dimension_table %>%
  select(PATIENT_NUM, AGE_IN_YEARS_NUM, BIRTH_DATE, LANGUAGE_CD, RACE_CD, ZIP_CD)


```


Loading the dictionary relevant to the demographic eCRF

```{r}
data_dictionnary <- read.csv("../../common_ref/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv")%>%
  filter(Form.Name=="demographics")
```


Loading the county-state-zipcode datatable (https://github.com/scpike/us-state-county-zip)

```{r}
zip_table <- read_csv('https://raw.githubusercontent.com/scpike/us-state-county-zip/master/geo-data.csv')
```


Creation of the demographic eCRF table to fill-in. The column name are from the dictionnary and the number of row matches the number of rows of the patient_dimension table

```{r}

eCRF_table <- data.frame(matrix(ncol =36, nrow = nrow(Patient_dimension_table)))
name <- c("Patient_id", "dob", "lt_1_admit", "premature", "wks_gest_birth", "corrected_gest_age", "ethnicity", "language","langauge_other",
       "white", "black", "indian", "alaskan_native", "native_hawaiian", "pacific_islander", "asian", "race_other", "race_other_list","race_refused_unknown",
       "country", "country_other", "zipcodeus", "postalcode_canada", "usstate", "canadaprovince", "residence_other", "county", "census","censusdt",
       "censustract", "censusblock", "insurance", "insurance_primary", "other_studies", "other_studies_list","other_studies_other"
       )
colnames(eCRF_table) <- name


```



###ZIP CODE###

1) rename the column to fit the eCRF
2) Change the type of the column to text
3) the zip code were originally 4 digit. So a 0 is added at the beginning when the zipcode is 4 digit. If it is already a 5 digit zipcode it will remain the same
4) transfer the zip_column to the eCRF.We do a check of the patient's id for each row to be sure that we don't mix any data. 

```{r}
# 1)
names(Usefull_Patient_table)[names(Usefull_Patient_table) == 'ZIP_CD'] <- 'zipcodeus'

#2)
Usefull_Patient_table$zipcodeus<- as.character(Usefull_Patient_table$zipcodeus)
str(Usefull_Patient_table$zipcodeus)


#3)
for (i in 1:dim(Usefull_Patient_table)[1]) {
  if (nchar(Usefull_Patient_table$zipcodeus[i])==4) {
      Usefull_Patient_table$zipcodeus[i] <- paste("0", Usefull_Patient_table$zipcodeus[i], sep="")
    }else{
      Usefull_Patient_table$zipcodeus[i]<-Usefull_Patient_table$zipcodeus[i]
    }
}

#4)

for (i in 1:dim(Usefull_Patient_table)[1]){
for (j in 1:dim(eCRF_table)[1]){
if(eCRF_table$Patient_id[j]==Usefull_Patient_table$PATIENT_NUM[i]){
  eCRF_table$zipcodeus[j] <- Usefull_Patient_table$zipcodeus[i]
}else{
}
  
}
}

```




###Country###
Country of residence: 1, US | 2, Canada | 3, Other
If there is a zipcode, it means that the patient is a US resident. So we are looking into the eCRF zipcode column. If there is a value, country should be 1.
```{r}

identify_country <- function(zipcode) {
  if (is.null(zipcode)) {
    return('')
  } else {
    return(1)
  }
}

eCRF_table <- eCRF_table %>% 
  mutate(country = identify_country(zipcodeus))

```

###US state and County###

Identify state abbreviation and county based on zipcode

```{r}

eCRF_table <- eCRF_table %>%
  left_join(zip_table %>%
              select(state_abbr, county, zipcode),
            by = c('zipcodeus' = 'zipcode')) %>%
  mutate(usstate = state_abbr,
         county = county.x) %>%
  select(-state_abbr,
         -county.x, county.y)

```


###Language###
Language data dictionary: 1, English | 2, Spanish | 3, Both English and Spanish | 4, Other | 99, Decline to answer

1) We add the language column to the patient_table.
2) We fill the column with the information corresponding to the requirement of the dictionary
3) Then we copy this column to the eCRF table. We do a check of the patient's id for each row to be sure that we don't mix any data. 

```{r}
#1)
Usefull_Patient_table$language <- NA
 
#2) 
for (i in 1:dim(Usefull_Patient_table)[1]) {
    if (tolower(Usefull_Patient_table$LANGUAGE_CD[i]) == "english") {
      Usefull_Patient_table$language[i]= 1 
    } else if(tolower(Usefull_Patient_table$LANGUAGE_CD[i]) == "spanish") {
      Usefull_Patient_table$language[i]= 2
    }else{
      Usefull_Patient_table$language[i]= 4
    }
}

## not sure how case 3 (both english and spanish) or case 99 (decline to answer) would appear in the EHR
# should check with other sites and as more patients are added
categorize_language <- function(language){
  language <- tolower(language)
  if (language == 'english') {
    return(1)
  } else if (language == 'spanish') {
    return(2)
  } else {
    return(4)
  }
  
}

#3)

for (i in 1:dim(Usefull_Patient_table)[1]){
for (j in 1:dim(eCRF_table)[1]){
if(eCRF_table$Patient_id[j]==Usefull_Patient_table$PATIENT_NUM[i]){
  eCRF_table$language[j] <- Usefull_Patient_table$language[i]
}else{
}
  
}
}


```

###language other###

we check the eCRF table to select the row with a "4" in the language.Once we check that the id is correct, we populate the "language other" 
from this row with the string in the patient_table's language column

```{r}

for (i in 1:dim(eCRF_table)[1]){
for (j in 1:dim(Usefull_Patient_table)[1]){
  
if(eCRF_table$language[i]==4 && eCRF_table$Patient_id[i]==Usefull_Patient_table$PATIENT_NUM[j]){
  eCRF_table$langauge_other[i] <- Usefull_Patient_table$LANGUAGE_CD[j]
}else{
}
  
}
}


```

###Races### 
1)We load the mapping for the races. 
2)We add all the races column to the patient_table.
3)We fill the column with the information corresponding to the requirement of the dictionary
4)Then we copy this column to the eCRF table. We do a check of the patient's id for each row to be sure that we don't mix any data. 

```{r}
#1) 
race_mapping <- read.csv("../data/Race_mapping.csv",sep = ";")
race_mapping

#2)

Usefull_Patient_table$white <- NA
Usefull_Patient_table$black <- NA
Usefull_Patient_table$indian <- NA
Usefull_Patient_table$alaskan_native <- NA
Usefull_Patient_table$native_hawaiian <- NA
Usefull_Patient_table$pacific_islander <- NA
Usefull_Patient_table$asian <- NA
Usefull_Patient_table$race_other <- NA
Usefull_Patient_table$race_refused_unknown <- NA




for (j in 1:dim(Usefull_Patient_table)[1]){

  
  if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$white)){
    Usefull_Patient_table$white[j] <- 1
  }else{
    Usefull_Patient_table$white[j] <- 0
  }
    if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$black)){
    Usefull_Patient_table$black[j] <- 1
  }else{
    Usefull_Patient_table$black[j] <- 0
  }
    if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$indian)){
    Usefull_Patient_table$indian[j] <- 1
  }else{
    Usefull_Patient_table$indian[j] <- 0
  }
    if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$alaskan_native)){
    Usefull_Patient_table$alaskan_native[j] <- 1
  }else{
    Usefull_Patient_table$alaskan_native[j] <- 0
  }
    if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$native_hawaiian)){
    Usefull_Patient_table$native_hawaiian[j] <- 1
  }else{
    Usefull_Patient_table$native_hawaiian[j] <- 0
  }
    if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$pacific_islander)){
    Usefull_Patient_table$pacific_islander[j] <- 1
  }else{
    Usefull_Patient_table$pacific_islander[j] <- 0
  }
    if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$asian)){
    Usefull_Patient_table$asian[j] <- 1
  }else{
    Usefull_Patient_table$asian[j] <- 0
  }
    if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$race_other)){
    Usefull_Patient_table$race_other[j] <- 1
  }else{
    Usefull_Patient_table$race_other[j] <- 0
  }
      if(tolower(Usefull_Patient_table$RACE_CD[j]) %in% tolower(race_mapping$race_refused_unknown)){
    Usefull_Patient_table$race_refused_unknown[j] <- 1
  }else{
    Usefull_Patient_table$race_refused_unknown[j] <- 0
  }
  
  
  
}


for (i in 1:dim(eCRF_table)[1]){
for (j in 1:dim(Usefull_Patient_table)[1]){
if(eCRF_table$Patient_id[j]==Usefull_Patient_table$PATIENT_NUM[i]){
  eCRF_table$white[i] <- Usefull_Patient_table$white[j]
  eCRF_table$black[i] <- Usefull_Patient_table$black[j]
  eCRF_table$indian[i] <- Usefull_Patient_table$indian[j]
  eCRF_table$alaskan_native[i] <- Usefull_Patient_table$alaskan_native[j]
  eCRF_table$native_hawaiian[i] <- Usefull_Patient_table$native_hawaiian[j]
  eCRF_table$pacific_islander[i] <- Usefull_Patient_table$pacific_islander[j]
  eCRF_table$asian[i] <- Usefull_Patient_table$asian[j]
  eCRF_table$race_other[i] <- Usefull_Patient_table$race_other[j]
  eCRF_table$race_refused_unknown[i] <- Usefull_Patient_table$race_refused_unknown[j]
}else{
}
  
}
}



```

Display of the final eCRF table

```{r}
View(eCRF_table)

write.csv(eCRF_table, "../local_ref/Test_eCRF.csv")
```

