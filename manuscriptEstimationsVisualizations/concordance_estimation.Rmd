---
title: "Concordance estimation: manual entry vs. automatic entry"
author: "Alba Gutiérrez-Sacristán & Simran Makwana"
date: "2023-09-22"
output: html_document
---

# Load libraries
```{r}
rm(list=)
library(dplyr)
library(tidyr)
library(eulerr)
```

# Laboratory values
## Load the files
We need 3 files as input:
- The TCH automatic file generated with our etl pipeline
- The TCH manual file, downloaded from REDCap with the manual data entered
- The MUSIC data dictionary
```{r}
auto_tch <- read.csv('../laboratory_values/local_ref/lab_output_texas_092023.csv', colClasses ="character")
#auto_tch <- read.csv('../laboratory_values/local_ref/lab_output_texas_092023_testInpatient_other.csv', colClasses ="character")

manual_tch <- read.csv("../laboratory_values/local_ref/texasChildren/MUSIC_DATA_2023-09-01_1508.csv", colClasses =  "character") %>%
  filter( record_id %in% auto_tch$record_id ) #filtering by the common patients

# MUSIC data dictionary from the general common_ref folder
datadict <- read.csv('../common_ref/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv')
```

## Laboratory values selection
```{r}
lab_datadict <- datadict %>% 
  dplyr::filter(Form.Name == "laboratory_values") 

auto_tch <- auto_tch %>%
  dplyr::filter( redcap_repeat_instrument == "laboratory_values")

manual_tch <- manual_tch %>%
  dplyr::filter( redcap_repeat_instrument == "laboratory_values")
```

### Get the number of distinct laboratory variables
```{r}
labVar <- lab_datadict %>% 
  dplyr::filter( Field.Label == "Obtained") %>%
  dplyr::select( Section.Header ) %>%
  unique()

print(paste0("Total laboratory variables:", nrow(labVar)))
```


## Identify the data in-scope
We define the data in scope as those variables that can be automatically extractable, and the we can then compare in the manual vs. automatic data entry. 

### Reformat the data
Create an id based on the patient ID and the visit value and pivot the data to have tables with 3 columns:
- id 
- variable
- value

```{r}
totalManualVar <- manual_tch %>%
  dplyr::select( c("record_id", lab_datadict$Variable...Field.Name) ) 

totalManualVar <- totalManualVar %>%
  tidyr::pivot_longer( cols = c(2:ncol( totalManualVar)), 
                       names_to = "variable", 
                       values_to = "value_manual") %>%
  dplyr::filter( ! value_manual %in% c("", " ")) 
nrow( totalManualVar)

manual_tch <- manual_tch %>%
  dplyr::select( c("record_id", lab_datadict$Variable...Field.Name) ) %>%
  dplyr::mutate( id=paste0( record_id, "-",lab_values_visit)) %>%
  dplyr::select( -record_id, - lab_values_na, - lab_values_visit ) 

manual_tch <- manual_tch %>% # remove columns that are not needed
  tidyr::pivot_longer( cols = c(1:ncol( manual_tch) - 1), 
                       names_to = "variable", 
                       values_to = "value_manual") %>%
  dplyr::filter( ! value_manual %in% c("", " ")) 

auto_tch <-  auto_tch %>%
  dplyr::mutate( id=paste0( record_id, "-",lab_values_visit)) %>%
  dplyr::select( -record_id, -lab_values_visit, - redcap_event_name, - redcap_repeat_instrument,-redcap_repeat_instance ) # remove columns that are not needed

auto_tch <- auto_tch %>%
  tidyr::pivot_longer( cols = c(1:ncol(auto_tch)-1), 
                       names_to = "variable", 
                       values_to = "value_auto") %>%
  dplyr::filter( value_auto != "") 

```
Identify the variables that are in scope (auto extract possible). 
```{r}
nrow(manual_tch)
manual_tch_in_scope <- manual_tch %>%
  dplyr::filter( variable %in% auto_tch$variable )
nrow(manual_tch_in_scope)

manual_tch_Not_in_scope <- manual_tch %>%
  dplyr::filter( ! variable %in% auto_tch$variable )

toCheck <- as.data.frame( table( manual_tch_Not_in_scope$variable))
```
## For the auto-extraction, get how many variables we had per time point
```{r}
dim(auto_tch)

numbers_table3 <- auto_tch %>%
  dplyr::mutate( visit = sapply(strsplit( id, "-"), '[', 2))
```

## Get the concordance 
We merge the manual_tch_in_scope with the auto_tch one, and we estimate for how many cases the value is the same in both. 
```{r}
manualVsauto <- left_join( manual_tch_in_scope, auto_tch, by =c("id", "variable"))
```

We #re-format dates changing NA auto values to 0 when manual is 0 and auto is NA and removing .0 from 4.0, 13.0 etc. 
We also remove white spaces and make sure everything is comparable. 
Finally we do the comparison to assign which cases are the same and which ones are different.
```{r}
#manualVsauto2 <- manualVsauto
manualVsauto <- manualVsauto %>%
  dplyr::mutate( value_manual = as.character( trimws( value_manual)), 
                 value_manual = ifelse( grepl( "\\.0$", value_manual) == TRUE, 
                                        gsub("\\.0", "", value_manual), value_manual ),
                 value_auto = as.character( trimws( value_auto)), 
                 value_auto = gsub("<", "", value_auto ),
                 value_auto = ifelse( grepl( "\\.0$", value_auto) == TRUE, 
                                        gsub("\\.0", "", value_auto), value_auto ))

manualVsauto <- manualVsauto %>%
  dplyr::mutate( type = sapply(strsplit( variable, "_"), tail, 1),
                 #value_auto =  #ifelse( type == "date",  
                               #as.character( as.Date( value_auto, format = "%m/%d/%Y")),
                               #value_auto), 
                 value_manual = as.character( trimws( value_manual)), 
                 value_auto = as.character( trimws( value_auto)), 
                 value_auto = ifelse( value_manual == 0 & is.na(value_auto), 0, value_auto ),
                 concordance = ifelse( value_manual == value_auto, "same", "different"))
```

Get a summary of the results
```{r}
results <- summary(as.factor( manualVsauto$concordance))
results
round(as.numeric(100* results["same"]/nrow(manualVsauto)), 2)

same <- manualVsauto %>% filter( concordance == "same")
different <- manualVsauto %>% filter( concordance == "different")
missing <- manualVsauto %>% filter( is.na(concordance) )
different <- different %>% mutate( patient = sapply(strsplit( id, "-"), '[', 1), visit = sapply(strsplit( id, "-"), '[', 2))
obtained <- different %>% filter( type == "obtained" & value_auto == 0)
obtained_manual0 <- different %>% filter( type == "obtained" & value_manual == 0)

```
Further investigate the results that are different. 
```{r}
different  %>% 
  dplyr::filter( type == "obtained" ) %>%
  dplyr::group_by( value_manual ) %>%
  dplyr::summarise( n = n())

dates_diff <- different %>%
  dplyr::filter( type == "date") %>%
  dplyr::mutate( dateDiff = as.Date(value_manual) - as.Date(value_auto))

summary(as.factor( dates_diff$dateDiff))

dates_diff %>%
  dplyr::group_by( visit, dateDiff ) %>%
  dplyr::summarise( n = n())
```


Plot the overlap
```{r}
totalA = sum(results)
totalB = nrow(auto_tch)
common = as.numeric(results["same"])
vd <- euler(c(manual=totalA, auto=totalB, "manual&auto"= common))
plot(vd, legend = TRUE, quantities =  list(type = c("counts", "percent")), fills = c("lightblue2", "lightyellow"))
```

## Get the values of same and different by visit number
```{r}
manualVsauto_visitNum <- manualVsauto %>%
  dplyr::mutate( visit_num = sapply(strsplit( id, "-"), '[', 2),
                 concordance = ifelse( is.na( concordance), "different", concordance)) %>%
  #dplyr::filter( id %in% auto_tch$id ) %>%
  dplyr::group_by( visit_num, concordance ) %>%
  dplyr::summarise( n = n()) 

###
manualVsauto_visitNum <- manualVsauto_visitNum %>%
  dplyr::ungroup() %>%
  dplyr::group_by( visit_num ) %>%
  dplyr::summarise( concordance = concordance,
                    val = n,
                    total = sum(n), 
                    perc = round(n/total*100, 2))
```


## Get the values without using as reference the manual 
Use a full join instead of a left join. 
```{r}
autoVsManual <- full_join( manual_tch_in_scope, auto_tch, by =c("id", "variable"))

autoVsManual_t3 <- autoVsManual %>%
  dplyr::mutate( visit = sapply(strsplit( id, "-"), '[', 2 )) %>%
  dplyr::mutate( value_manual = as.character( trimws( value_manual)), 
                 value_manual = ifelse( grepl( "\\.0$", value_manual) == TRUE, 
                                        gsub("\\.0", "", value_manual), value_manual ),
                 value_auto = as.character( trimws( value_auto)), 
                 value_auto = gsub("<", "", value_auto ),
                 value_auto = ifelse( grepl( "\\.0$", value_auto) == TRUE, 
                                        gsub("\\.0", "", value_auto), value_auto ), 
                 value_manual = as.character( trimws( value_manual)), 
                 value_auto = as.character( trimws( value_auto)), 
                 updated_auto = ifelse( value_manual == 0 & is.na(value_auto), 0, value_auto )) %>%
  dplyr::mutate( concordance_real = ifelse( value_manual == value_auto, "same", "diff"),
                 concordance_inf = ifelse( value_manual == updated_auto, "same", "diff"))

tabl3_columnConcordance <- autoVsManual_t3 %>%
  dplyr::filter( ! is.na( value_manual )) %>%
  dplyr::group_by( visit, concordance_inf ) %>%
  #dplyr::group_by( visit, concordance_real ) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::arrange( visit )


tabl3_columnAuto <- autoVsManual_t3 %>%
  dplyr::filter( ! is.na( updated_auto )) %>%
  #dplyr::filter( ! is.na( value_auto )) %>%
  dplyr::group_by( visit ) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::arrange( visit )

addingInfo <- autoVsManual %>%
  dplyr::filter( is.na(value_manual) ) %>%
  dplyr::mutate( visit = sapply(strsplit( id, "-"), '[', 2), 
                 lab_var = sapply(strsplit( variable, "_"), '[', 1), 
                 var_type = sapply(strsplit( variable, "_"), function(x) tail(x, n = 1)))

summaryByVisitNum <- addingInfo %>%
  dplyr::group_by( visit) %>%
  dplyr::summarise(n = n())

summaryOfTypes <- addingInfo %>%
  dplyr::group_by( visit, var_type ) %>%
  dplyr::summarise(n = n())

manual_tch_in_scope %>%
  dplyr::mutate( visit = sapply(strsplit( id, "-"), '[', 2)) %>%
  dplyr::group_by( visit) %>%
  dplyr::summarise(n = n())

auto_tch %>%
  dplyr::mutate( visit = sapply(strsplit( id, "-"), '[', 2)) %>%
  dplyr::group_by( visit) %>%
  dplyr::summarise(n = n())

```


# Medication values 

## Load the files
We need 3 files as input:
- The TCH automatic file generated with our etl pipeline
- The TCH manual file, downloaded from REDCap with the manual data entered
- The MUSIC data dictionary
```{r}
rm(list=ls())
auto_tch <- read.csv('../medications_during/local_ref/tch_medications_during_092023.csv', colClasses ="character")

# tch manual file downloaded from REDCap
manual_tch <- read.csv("../laboratory_values/local_ref/texasChildren/MUSIC_DATA_2023-09-01_1508.csv", colClasses =  "character") %>%
  filter( record_id %in% auto_tch$record_id ) #filtering by the common patients


# MUSIC data dictionary from the general common_ref folder
datadict <- read.csv('../common_ref/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv')
```

## Medication values selection
```{r}
datadict <- datadict %>% 
  dplyr::filter(Form.Name == "additional_medications_during_hospitalization") 

manual_tch <- manual_tch %>%
  dplyr::filter( redcap_repeat_instrument == "additional_medications_during_hospitalization")

auto_tch <- auto_tch %>%
  dplyr::filter( redcap_repeat_instrument == "additional_medications_during_hospitalization")
```



### Get the number of distinct medication variables
```{r}
medVar <- datadict %>% 
  dplyr::filter( grepl( "^Medication 1 Code", Field.Label)  == TRUE) %>%
  dplyr::mutate( medCategory = gsub("Medication 1 Code", "", Field.Label )) %>%
  dplyr::select( medCategory ) %>%
  unique()

print(paste0("Total medication categories:", nrow(medVar)))
```

## Transform into table that are comparables
```{r}
auto_tch <-  auto_tch %>%
  dplyr::select( - redcap_event_name, - redcap_repeat_instrument ) # remove columns that are not needed

auto_tch <- auto_tch %>%
  tidyr::pivot_longer( cols = c(3:ncol(auto_tch)), 
                       names_to = "variable", 
                       values_to = "value_auto") %>%
  dplyr::filter( value_auto != "") 


auto_tch_toCompare <- auto_tch %>%
  dplyr::mutate( mednum = sapply(strsplit( variable, "_"), head, 1),
                 medtype =  sapply(strsplit( variable, "_"), '[', 2))%>%
  dplyr::group_by( record_id, redcap_repeat_instance, mednum ) %>%
  dplyr::arrange(factor(medtype, levels = c("type", "code", "name", "start"))) %>%
  dplyr::summarise( counts = n(), 
                    new_val = ifelse( counts == 1, value_auto, paste(value_auto, collapse="*")))

#remove the .99 ones
auto_tch_toCompare <- auto_tch_toCompare %>%
  dplyr::filter( grepl( "\\.99", new_val ) == FALSE)
  
print(paste0("Total medication values extracted automatically: ", sum( auto_tch_toCompare$counts)))


manual_tch <- manual_tch %>%
  dplyr::select( c("record_id", "redcap_repeat_instance",  datadict$Variable...Field.Name) ) %>%
  dplyr::select( - med_na )

manual_tch <- manual_tch %>% # remove columns that are not needed
  tidyr::pivot_longer( cols = c(3:ncol(manual_tch)), 
                       names_to = "variable", 
                       values_to = "value_auto") %>%
  dplyr::filter( value_auto != "" & value_auto != 0 ) 

manual_tch_toCompare <- manual_tch %>%
  dplyr::mutate( mednum = sapply(strsplit( variable, "_"), head, 1),
                 medtype =  sapply(strsplit( variable, "_"), '[', 2))%>%
  dplyr::group_by( record_id, redcap_repeat_instance, mednum ) %>%
  dplyr::arrange(factor(medtype, levels = c("type", "code", "name", "start"))) %>%
  dplyr::summarise( counts = n(), 
                    new_val = ifelse( counts == 1, value_auto, paste(value_auto, collapse="*")))

#remove the .99 ones
manual_tch_toCompare <- manual_tch_toCompare %>%
  dplyr::filter( grepl( "\\.99", new_val ) == FALSE)
  
print(paste0("Total medication values entered manually: ", sum( manual_tch_toCompare$counts)))


```


## Merge auto and manual extraction to get the performance

```{r}
# merge both files by the id we have created and the variable name
manual <- manual_tch_toCompare %>%
  dplyr::ungroup() %>%
  dplyr::mutate( id = paste0( record_id, "###", new_val )) %>%
  dplyr::select( record_id, manual_val = new_val, manual_counts= counts, id ) %>%
  unique()

auto <- auto_tch_toCompare %>%
  dplyr::ungroup() %>%
  dplyr::mutate( id = paste0( record_id, "###", new_val )) %>%
  dplyr::select( record_id, auto_val = new_val, auto_counts = counts, id ) %>%
  unique()

manualVsauto <- full_join( manual, auto, by =c("id", "record_id")) %>%
  dplyr::mutate( auto_counts = ifelse( is.na(auto_counts), 0, auto_counts ), 
                 manual_counts = ifelse( is.na(manual_counts), 0, manual_counts ), 
                total_counts = ifelse( manual_counts == auto_counts, auto_counts, 
                                        ifelse( manual_counts == 0, auto_counts, manual_counts))) %>%
  dplyr::select( record_id, id, manual_val, auto_val, total_counts )

manualNotAuto <- manual[ ! manual$id %in% auto$id, ]
manualAndAuto <- manual[ manual$id %in% auto$id, ]

print(paste0( "Total medication values entered manually:", sum(manual$manual_counts))) 
print(paste0( "Concordance: ", sum(manualAndAuto$manual_counts))) 

print(paste0( "Concordance (in %): ", round(100*sum(manualAndAuto$manual_counts)/sum(manual$manual_counts), 2), "%"))
```

Plot the overlap
```{r}
totalA = sum(manual$manual_counts)
totalB = nrow(auto_tch)
common = sum(manualAndAuto$manual_counts)
vd <- euler(c(manual=totalA, auto=totalB, "manual&auto"= common))
plot(vd, legend = TRUE, quantities =  list(type = c("counts", "percent")), fills = c("coral", "lightgrey"))
```

## Get the number of labs and meds values automatically extracted for BCH

```{r}
rm(list=ls())

bch_labs <- read.csv('../laboratory_values/local_ref/redcap_output_laboratory_values_updated.csv', colClasses ="character") %>%
  dplyr::filter( redcap_repeat_instrument == "laboratory_values")
length(unique(bch_labs$record_id))

bch_labs <-  bch_labs %>%
  dplyr::mutate( id=paste0( record_id, "-",lab_values_visit)) %>%
  dplyr::select( -record_id, -lab_values_visit, - redcap_event_name, - redcap_repeat_instrument,-redcap_repeat_instance ) # remove columns that are not needed

bch_labs <- bch_labs %>%
  tidyr::pivot_longer( cols = c(1:ncol(bch_labs)-1), 
                       names_to = "variable", 
                       values_to = "value_auto") %>%
  dplyr::filter( value_auto != "") 

print(paste0("Laboratory values extracted for BCH: " , nrow( bch_labs)))

####
bch_meds <- read.csv('../medications_during/local_ref/redcap_output_medications_during.csv', colClasses ="character") %>%
  dplyr::filter( redcap_repeat_instrument == "additional_medications_during_hospitalization")
length(unique(bch_meds$record_id))

bch_meds <-  bch_meds %>%
  dplyr::select( - redcap_event_name, - redcap_repeat_instrument ) # remove columns that are not needed

bch_meds <- bch_meds %>%
  tidyr::pivot_longer( cols = c(3:ncol(bch_meds)), 
                       names_to = "variable", 
                       values_to = "value_auto") %>%
  dplyr::filter( value_auto != "")  %>%
  dplyr::filter( grepl( "\\.99", value_auto ) == FALSE)
  
print(paste0("Total medication values extracted automatically: ", nrow( bch_meds)))

```



####### No needed 
## Investigate the .99 meds
```{r}
#identify the meds that are manually entered as .99 in their respective categories
# otherMeds <- manualNotAuto %>%
#   dplyr::mutate( others = ifelse( grepl("\\.99", manual_val) == TRUE, "other" , "non")) %>%
#   dplyr::filter(others == "other" ) %>%
#   dplyr::select(manual_val, manual_counts )
# 
# print( paste0("Meds categorized as others: ", sum(otherMeds$manual_counts)))
# 
# otherMeds <- otherMeds %>% unique()
# 
# medsVals <- otherMeds %>%
#   dplyr::mutate( med_description = ifelse( manual_counts == 4, 
#                                            sapply(strsplit( manual_val, "[*]"), '[', 3), 
#                                            ifelse( manual_counts == 3 & grepl("^99.99",manual_val)== TRUE, sapply(strsplit( manual_val, "[*]"), '[', 2),
#                                                    sapply(strsplit( manual_val, "[*]"), '[', 3))) ) %>% dplyr::select( med_description ) %>% unique()
# 
# ## save the values and look for the equivalent that we have in the EHR
# write.table( medsVals, file = "../medications_during/medsFreeText.txt", col.names = TRUE, row.names = FALSE, quote = FALSE, sep = "\t")
```

We mapped the meds that we found that we codified as 99.99 to the same name that they entered manually. We also found a typo on their end for Doxycyline, that is Doxycycline. We will update that on the manual description of the variables for further comparison. 
Not all the meds they entered as .99 we have in the 99.99 category, some as Remdesivir or Enalapril, had their own category different than .99. 

### Check the ones that are distinct than other, to identify potential mapping issues
```{r}
# missingMeds <- manualNotAuto %>%
#   dplyr::mutate( others = ifelse( grepl("\\.99", manual_val) == TRUE, "other" , "non")) %>%
#   dplyr::filter(others == "non" ) %>%
#   dplyr::mutate( medCode = sapply(strsplit( manual_val, "[*]"), '[', 2),)
# 
# summary(as.factor(missingMeds$medCode))

# we review the ones with the highest number of missing values:
# 09.03: gamma globuline
# 18.09: methylprednisolone/prednisolone
```
## Estimate the concordance if we consider equivalent X.99 with 99.99
To do this, we will take the "other medications" and we will:
1. transform the X.99 into 99.99
2. rename the medications to be in the same way (we have the complete extended version and they just entered the main word; e.g, Doxycycline	vs. doxycycline hyclate 100 mg oral caps)

Once we adjust these two things, we will re-create the original dataset and re-estimate the concordance. 
```{r}
# in the manual data one, we replace the X.99 by 99.99
# otherMeds <- manualNotAuto %>%
#   dplyr::mutate( others = ifelse( grepl("\\.99", manual_val) == TRUE, "other" , "non")) %>%
#   dplyr::filter(others == "other" ) %>%
#   dplyr::mutate( med_description = ifelse( manual_counts == 4, 
#                                            sapply(strsplit( manual_val, "[*]"), '[', 3), 
#                                            ifelse( manual_counts == 3 & grepl("^99.99",manual_val)== TRUE, sapply(strsplit( manual_val, "[*]"), '[', 2),
#                                                    sapply(strsplit( manual_val, "[*]"), '[', 3))) ) %>%
#   dplyr::mutate( med_description = tolower( med_description ),
#                  manual_val_updated = ifelse(grepl("^99.99",manual_val)== TRUE, 
#                                              manual_val,
#                                              paste0("99.99*", med_description)), 
#                  id = paste0(record_id,"###", manual_val_updated)) %>%
#   select( - med_description, -others)
# 
# # in the automatic one, we rename the descriptions with the updated value and remove the date
# mappingOtherMeds <- read.delim("../medications_during/medsFreeText_mapped.txt") %>%
#   dplyr::select( med_description, ehr_description )
# mappingOtherMeds$med_description <- tolower( trimws(mappingOtherMeds$med_description))
# mappingOtherMeds$ehr_description <- trimws(mappingOtherMeds$ehr_description)
# 
# auto_others <- auto_tch_toCompare %>%
#   dplyr::mutate( others = ifelse( grepl("^99.99", new_val) == TRUE, "other" , "non")) %>%
#   dplyr::filter( others == "other" ) %>%
#   dplyr::select( - others ) %>%
#   dplyr::mutate( ehr_description = sapply(strsplit( new_val, "[*]"), '[', 2)) %>%
#   dplyr::left_join( mappingOtherMeds )
# 

### considered originally 99.99 we want to keep the date for the rest remove
### influenza seasonal IIV4 vaccine, vasopressin, oxymetazoline, risperidone, carbidopa-levodopa
# auto_others_mapped <- auto_others %>%
#   dplyr::filter( ! is.na( med_description )) %>%
#   dplyr::mutate( new_val_updated = ifelse( med_description %in% c("influenza seasonal IIV4 vaccine", "vasopressin", "oxymetazoline", "risperidone", "carbidopa-levodopa"), 
#                                            paste0("99.99*",med_description, sapply(strsplit( new_val, "[*]"), '[', 3)), paste0("99.99*", med_description )), 
#                  id = paste0(record_id,"###", new_val_updated))
# 
# # estimate the additional values that would be mapped 
# commonOthers <- otherMeds[ otherMeds$id %in% auto_others_mapped$id, ]
```

Plot the overlap
```{r}
# totalA = sum(manual$manual_counts)
# totalB = nrow(auto_tch)
# common = sum(manualAndAuto$manual_counts)+sum(commonOthers$manual_counts)
# vd <- euler(c(manual=totalA, auto=totalB, "manual&auto"= common))
# plot(vd, legend = TRUE, quantities =  list(type = c("counts", "percent")), fills = c("coral", "lightgrey"))
```

# Session Information Summary
```{r}
sessionInfo()
```
