---
title: 'ETL: Medications Before and After Hospitilization eCRf'
author: "Simran Makwana"
date: "6/15/2021"
output: html_document
---

*this notebook should be using HOMEMED concepts, but Sajad only mapped these variables to ADMINMED concepts. we are using the ADMINMED concepts here but will need to change it later*

# This notebook contains the following steps:
1.Load data extract for the concept of interest
2. Determine expected values for REDCap 
3. Calculate medcur1_current column
  a. Incorporate patient timeline (or just start and end date) to determine medcur1_current variable
4. Transform and format

# 0. Libraries
```{r}
library(tidyverse)
library(lubridate)
```

# 1. Load data extract for the concept of interest

Example: In BCH, we run the following query to obtain the data extract for all medication data for our MISC patietns.
create table ag440_music_meds as 
select obs.patient_num, obs.concept_cd, obs.start_date, misc.admissiondate, misc.end_date, misc.length_of_stay 
from observation_fact obs, ag440_misc_patients_may misc 
where (concept_cd like 'HOMEMED:%' or concept_cd like 'ADMINMED:%' or concept_cd like 'AG:%') and obs.patient_num = misc.patient_num;

The results of the above query have been saved.

```{r}

agg_music_meds <- read.csv('../local_ref/agg40_music_meds.csv')

# filter dataframe to only include 'HOMEMED' codes as we are only interested in medications taken before and after hospitalization
# 'ADMINMED' codes are given during hospitalization and 'AG' codes are for allergies
#agg_music_meds <- agg_music_meds %>% filter(!grepl('AG|ADMINMED', CONCEPT_CD))

```

We are currently using the concepts which were identified in Sajad's initial eCRF variable to BCH concept cd mapping.

```{r}
# This code is used to convert the list of medication mapping found in eCRF to BCH mapping_ medications - medications_before_and_after_hosp.csv into a list of concepts to test query

mapping <- read.csv('../data/eCRF to BCH mapping_ medications - medications_before_and_after_hosp.csv')

submapping <- mapping %>% 
  filter(Notes == '') %>%
  select(Variable...Field.Name,concept_cd,expected.value,expected.value.description)

# uncomment the code below if you would like to test using a smaller subset of Sajad's concepts

# sample_subdf <- sample_n(subdf, 50, replace = FALSE)

# sample_concepts <- sample_subdf %>% pull(concept_cd) %>% paste0(collapse = "', '")

#sample_query <- paste0("select obs.patient_num, obs.concept_cd, obs.start_date, obs.tval_char, obs.nval_num, obs.units_cd, pat.admission_date, pat.discharge_date 
#  from observation_fact obs, sa_diag_mis_c_patients pat 
#  where obs.patient_num = pat.patient_num 
#  and obs.concept_cd in ('", 
#                       sample_concepts, 
#                       "');")
#                       

#write.table(sample_query, '../local_ref/initial_extraction.sql.txt', row.names = FALSE, quote = FALSE, col.names = FALSE)

```

# 2. Determine expected values for REDCap 

Right now, we are using Sajad's mapping. 

In the future, we will use the CSV generated from the meds code list. 

```{r}
expected_vals <- read.csv('../data/eCRF to BCH mapping_ medications - medications_before_and_after_hosp.csv')

df <- left_join(df, expected_vals %>% select(concept_cd, expected.value, Variable...Field.Name), by = c("CONCEPT_CD" = "concept_cd"))

```


# 3. Calculate medcur1_current column

*currently, readmission is not calculated - will need patient timeline* 

The variable medcur1_current is a checkbox variable where sites check off which time points the medication was taken.  Each follow up visit, if the participant is still on the medication, the site can return to the same form already entered for that medication, and check off the box saying they are still on it.  In the data dictionary, itâ€™s codelist is: 
- 0: Before hospitalization for MIS-C (for pre-existing conditions)
- 1: Between hospital discharge and 2 Week visit
- 2: 2 Weeks Post-Discharge
- 3: Between the 2 Week and 6 Week visit
- 4: 6 Weeks Post-Discharge
- 5: Between the 6 Week and 3 Month visit
- 6: 3 Months Post-Discharge
- 7: Between the 3 Month and 6 Month visit
- 8: 6 Months Post-Discharge
- 9: Between the 6 Month and 1 Year visit
- 10: 1 Year Post-Discharge
- 11: Between the 1 Year and 2 Year visit
- 12: 2 Years Post-Discharge
- 13: Between the 2 Year and 3 Year visit
- 14: 3 Years Post-Discharge
- 15: Between the 3 Year and 4 Year visit
- 16: 4 Years Post-Discharge
- 17: Between the 4 Year and 5 Year visit
- 18: 5 Years Post-Discharge
- 20: At the time of readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)
- 19: Medication given during a readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)

```{r}

calculate_medcur1_current <- function(days_after_admission, days_after_discharge){
  # no need to wrap statements in ifelse loop because they are mutually exclusive
  if (days_after_admission < 0) {return(0)} # 0: Before hospitalization for MIS-C (for pre-existing conditions)
  if (days_after_discharge > 0 & days_after_discharge < 14) {return(1)} # 1: Between hospital discharge and 2 Week visit
  if (days_after_discharge == 14) {return(2)} # 2: 2 Weeks Post-Discharge
  if (days_after_discharge > 14 & days_after_discharge < 42) {return(3)} # 3: Between the 2 Week and 6 Week visit
  if (days_after_discharge == 42) {return(4)} # 4: 6 Weeks Post-Discharge
  if (days_after_discharge > 42 & days_after_discharge < 90) {return(5)} # 5: Between the 6 Week and 3 Month visit
  if (days_after_discharge == 90) {return(6)} # 6: 3 Months Post-Discharge
  if (days_after_discharge > 90 & days_after_discharge < 180) {return(7)} # 7: Between the 3 Month and 6 Month visit
  if (days_after_discharge == 180) {return(8)} # 8: 6 Months Post-Discharge
  if (days_after_discharge > 180 & days_after_discharge < 365) {return(9)} # 9: Between the 6 Month and 1 Year visit
  if (days_after_discharge == 365) {return(10)} # 10: 1 Year Post-Discharge
  ?
  if (days_after_discharge > 365 & days_after_discharge < 720) {return(11)} # 11: Between the 1 Year and 2 Year visit
  if (days_after_discharge == 720) {return(12)} # 12: 2 Years Post-Discharge
  if (days_after_discharge > 720 & days_after_discharge < 1095) {return(13)} # 13: Between the 2 Year and 3 Year visit
  if (days_after_discharge == 1095) {return(14)} # 14: 3 Years Post-Discharge
  if (days_after_discharge > 1095 & days_after_discharge < 1460) {return(15)} # 15: Between the 3 Year and 4 Year visit
  if (days_after_discharge == 1460) {return(16)} # 16: 4 Years Post-Discharge
  if (days_after_discharge > 1460 & days_after_discharge < 1825) {return(17)} # 17: Between the 4 Year and 5 Year visit
  if (days_after_discharge == 1825) {return(18)} # 18: 5 Years Post-Discharge
  # 19: Medication given during a readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)
  # 20: At the time of readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)
}

df <- df %>%
  mutate(date = dmy(sapply(strsplit( as.character(START_DATE), " "), '[', 1)),
         time = sapply(strsplit( as.character(START_DATE), " "), '[', 2),
         ADMISSION_DATE = dmy(ADMISSION_DATE),
         DISCHARGE_DATE = dmy(DISCHARGE_DATE),
         days_after_admission = date - ADMISSION_DATE,
         days_after_discharge = date - DISCHARGE_DATE) %>%
  rowwise %>%
  mutate(medcur1_current = calculate_medcur1_current(days_after_admission, days_after_discharge))


## add in redcap_repeat_instance (increments with each unique date / time combination
df2  <- df %>% 
  group_by(PATIENT_NUM, date, time) %>%
  arrange(date, time) %>%
  mutate(redcap_repeat_instance = cur_group_id()) %>%
  arrange(redcap_repeat_instance)


```


4. Transform and format

*Note the following criteria: "If this is the Week 2 - Month 6 Follow-Up visit, please exclude aspirin."*

Desired columns:
- record_id (patient_num)	
- redcap_event_name	(repeating_forms_arm_1) ??
- redcap_repeat_instrument (medications_before_and_after)
- redcap_repeat_instance	
- current_meds_fu_na (acknowledgement of participant eligibility - ignore / mark as 1 (acknowledged for all))
- medcur1_current (detailed in healthcore question document, but not in eCRF or in example redcap output)
- eCRF variables (with expected value)

```{r}

test <- pivot_wider(df,
                    id_cols = c(PATIENT_NUM, medcur1_current),     # include redcap repeat instance here
                    names_from = Variable...Field.Name,
                    values_from = expected.value,
                    values_fill = NA,
                    values_fn = list) # this suppresses a warning, must fix this


  
```





  