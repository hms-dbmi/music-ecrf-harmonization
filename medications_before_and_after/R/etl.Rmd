---
title: 'ETL: Medications Before and After Hospitilization eCRf'
author: "Simran Makwana"
date: "6/15/2021"
output: html_document
---


# This notebook contains the following steps:
1.Load data extract for the concept of interest
2. Determine expected values for REDCap 
3. Calculate medcur1_current column
  a. Incorporate patient timeline (or just start and end date) to determine medcur1_current variable
4. Transform and format

# 0. Libraries
```{r}
library(tidyverse)
library(lubridate)
```

# 1. Load data extract for the codes of interest

Example, in BCH, we create the following query to obtain the data extract for the codes identified in previous steps for MISC patients.
```{r}
bch_med_concept_summary <- read_csv('../data/bch_med_concept_summary_toReview.csv')

query_a <- "select obs.patient_num, obs.concept_cd, obs.start_date, misc.admissiondate, misc.end_date, misc.length_of_stay from observation_fact obs, ag440_misc_patients_may misc where (concept_cd in ('"

query_b <- "')) and obs.patient_num = misc.patient_num;"

bch_codes <- paste0(bch_med_concept_summary$CONCEPT_CD, collapse = "', '")

query <- paste0(query_a, bch_codes, query_b)

query

```

The results of the above query have been saved.
Load data dictionary to acquire variable names and merge with mapping file.
Load data extract and merge with mapping file to assign eCRF codes to each event.
```{r}

df <- read.csv('../local_ref/agg40_music_meds_filtered.csv')

datadict <- read.csv('../../common_ref/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv') %>%
  filter(Form.Name == 'medications_before_and_after_hosp') %>%
  select(Variable...Field.Name, Choices..Calculations..OR.Slider.Labels) 

# if the code is formatted like so: '2.00', convert to '02.00'
fix_code_formatting <- function(x) {
  ifelse(test = !grepl("[[:digit:]]{2}.", x), yes = (paste0('0', x)), no = (x))
}

datadict <- datadict %>% 
  filter(!Variable...Field.Name %in% c('current_meds_fu_na', 'medcur1_type', 'medcur1_name', 'medcur1_current', 'medcur1_readmit', 'medcur1_ae', 'medcur1_ae_num', 'medcalc')) %>%
  separate_rows(Choices..Calculations..OR.Slider.Labels, sep = '\\|') %>%
  mutate(ECRF_CODE = str_replace(Choices..Calculations..OR.Slider.Labels, ',.*$', ''),
         ECRF_CODE = str_trim(ECRF_CODE),
         ECRF_CODE = fix_code_formatting(ECRF_CODE)) %>%
  select(-Choices..Calculations..OR.Slider.Labels)

bch_med_concept_summary <- left_join(bch_med_concept_summary, datadict, by = 'ECRF_CODE')

df <- left_join(df, bch_med_concept_summary %>% select(ECRF_CODE, CONCEPT_CD, Variable...Field.Name), by = 'CONCEPT_CD')

```


# 3. Calculate medcur1_current column

*currently, readmission is not calculated - will need patient timeline* 

The variable medcur1_current is a checkbox variable where sites check off which time points the medication was taken.  Each follow up visit, if the participant is still on the medication, the site can return to the same form already entered for that medication, and check off the box saying they are still on it.  In the data dictionary, itâ€™s codelist is: 
- 0: Before hospitalization for MIS-C (for pre-existing conditions)
- 1: Between hospital discharge and 2 Week visit
- 2: 2 Weeks Post-Discharge
- 3: Between the 2 Week and 6 Week visit
- 4: 6 Weeks Post-Discharge
- 5: Between the 6 Week and 3 Month visit
- 6: 3 Months Post-Discharge
- 7: Between the 3 Month and 6 Month visit
- 8: 6 Months Post-Discharge
- 9: Between the 6 Month and 1 Year visit
- 10: 1 Year Post-Discharge
- 11: Between the 1 Year and 2 Year visit
- 12: 2 Years Post-Discharge
- 13: Between the 2 Year and 3 Year visit
- 14: 3 Years Post-Discharge
- 15: Between the 3 Year and 4 Year visit
- 16: 4 Years Post-Discharge
- 17: Between the 4 Year and 5 Year visit
- 18: 5 Years Post-Discharge
- 20: At the time of readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)
- 19: Medication given during a readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)

```{r}

calculate_medcur1_current <- function(days_after_admission, days_after_discharge){
  # no need to wrap statements in ifelse loop because they are mutually exclusive
  if (days_after_admission < 0) {return(0)} # 0: Before hospitalization for MIS-C (for pre-existing conditions)
  if (days_after_discharge > 0 & days_after_discharge < 14) {return(1)} # 1: Between hospital discharge and 2 Week visit
  if (days_after_discharge == 14) {return(2)} # 2: 2 Weeks Post-Discharge
  if (days_after_discharge > 14 & days_after_discharge < 42) {return(3)} # 3: Between the 2 Week and 6 Week visit
  if (days_after_discharge == 42) {return(4)} # 4: 6 Weeks Post-Discharge
  if (days_after_discharge > 42 & days_after_discharge < 90) {return(5)} # 5: Between the 6 Week and 3 Month visit
  if (days_after_discharge == 90) {return(6)} # 6: 3 Months Post-Discharge
  if (days_after_discharge > 90 & days_after_discharge < 180) {return(7)} # 7: Between the 3 Month and 6 Month visit
  if (days_after_discharge == 180) {return(8)} # 8: 6 Months Post-Discharge
  if (days_after_discharge > 180 & days_after_discharge < 365) {return(9)} # 9: Between the 6 Month and 1 Year visit
  if (days_after_discharge == 365) {return(10)} # 10: 1 Year Post-Discharge
  
  if (days_after_discharge > 365 & days_after_discharge < 720) {return(11)} # 11: Between the 1 Year and 2 Year visit
  if (days_after_discharge == 720) {return(12)} # 12: 2 Years Post-Discharge
  if (days_after_discharge > 720 & days_after_discharge < 1095) {return(13)} # 13: Between the 2 Year and 3 Year visit
  if (days_after_discharge == 1095) {return(14)} # 14: 3 Years Post-Discharge
  if (days_after_discharge > 1095 & days_after_discharge < 1460) {return(15)} # 15: Between the 3 Year and 4 Year visit
  if (days_after_discharge == 1460) {return(16)} # 16: 4 Years Post-Discharge
  if (days_after_discharge > 1460 & days_after_discharge < 1825) {return(17)} # 17: Between the 4 Year and 5 Year visit
  if (days_after_discharge == 1825) {return(18)} # 18: 5 Years Post-Discharge
  # 19: Medication given during a readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)
  # 20: At the time of readmission to the hospital (only readmissions related to MIS-C/COVID-19 symptoms/complications that occurred within 6 months of the initial hospitalization for MIS-C)
  
  if (days_after_admission >= 0 & days_after_discharge <= 0) {return(-88)} # this means that the code happens during hospitalization -- should not be reported here - made up number
  if (days_after_discharge > 1825) {return(100)} # this means the code happens later than defined in the scope of study -- use a made up number to report
}

df <- df %>%
  mutate(date = dmy(sapply(strsplit( as.character(START_DATE), " "), '[', 1)),
         time = sapply(strsplit( as.character(START_DATE), " "), '[', 2),
         DISCHARGE_DATE = dmy(sapply(strsplit( as.character(END_DATE), " "), '[', 1)),
         ADMISSION_DATE = dmy(ADMISSIONDATE),
         days_after_admission = date - ADMISSION_DATE,
         days_after_discharge = date - DISCHARGE_DATE) %>%
  rowwise %>%
  mutate(medcur1_current = calculate_medcur1_current(days_after_admission, days_after_discharge))

# remove any entries with medcur1_current value of -88 (happened during hospitalization) or 100 (happened after scope of study)
df <- df %>% filter(!medcur1_current %in% c(-88, 100))

## add in redcap_repeat_instance 
# "This is a repeating form, with only one medication per form"
df2 <- df %>%
  group_by(PATIENT_NUM) %>%
  select(-START_DATE, -END_DATE, -date, -time, -days_after_admission, -days_after_discharge) %>%
  unique() %>%
  arrange(medcur1_current) %>%
  mutate(redcap_repeat_instance = row_number()) 


```


4. Transform and format

*Note the following criteria: "If this is the Week 2 - Month 6 Follow-Up visit, please exclude aspirin."*

Desired columns:
- record_id (patient_num)	
- redcap_event_name	(repeating_forms_arm_1) ??
- redcap_repeat_instrument (medications_before_and_after)
- redcap_repeat_instance	
- current_meds_fu_na (acknowledgement of participant eligibility - ignore / mark as 1 (acknowledged for all))
- medcur1_current (detailed in healthcore question document, but not in eCRF or in example redcap output)
- medcur1_type
- eCRF variables (with expected value)

```{r}

df2 <- df2 %>% 
  mutate(medcur1_type = str_replace(str_replace(ECRF_CODE, '\\...', ''), '^0', ''))

out <- pivot_wider(df2,
                    id_cols = c(PATIENT_NUM, medcur1_current, redcap_repeat_instance, medcur1_type),   
                    names_from = Variable...Field.Name,
                    values_from = ECRF_CODE,
                    values_fill = NA) 


write.csv(out[,-1], '../local_ref/redcap_output_medications_before_and_after.csv', row.names = FALSE)
  
```
