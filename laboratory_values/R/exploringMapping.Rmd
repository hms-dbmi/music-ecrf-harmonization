---
title: "exploringMapping"
author: "Alba Guti√©rrez"
date: "5/11/2021"
output: html_document
---

## General description
This notebook contains the step by step to create a mapping file for the numerical lab values between the MUSIC dictionary file and the data in the pediatric database we are querying. 


## Required input
To run this code we need:
1. A file containing the mapping from the eCRF concept to the concepts in the format that they appear in the database we are querying ('eCRF to BCH mapping.csv')
2. The MUSIC dictionary file: 'MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv'
3. A table with the actual values for the selected concepts including the concept code, the value, and the units. 

## Load the libraries

```{r setup, include=FALSE}
library(devtools)
library(DBI)
library(ROracle)
library(readxl)
library(tidyverse)
library(dplyr)
```

## Select the laboratory related concepts
We read the 'eCRF to BCH mapping.csv' and extract the concept codes for the **laboratory_values**. We create then a string with the values to build the SQL query and extract the data from the DB. 

```{r}
ecrftobch <- read.csv("eCRF to BCH mapping.csv")
ecrftobch <- ecrftobch[ ecrftobch$Form.Name == "laboratory_values",]

labcodes <- unique( ecrftobch$labcodes)
labcodes <- labcodes[ labcodes != ""]
labcodes <- paste(labcodes, collapse = "','")
```

## Query the DB
With the previous vector containing the laboratory concept codes, we build a SQL query to extract the specific values for the MISC patients. 

The first step before running any query is to set up the connection:
```{r, eval=FALSE}
# con <- dbConnect(drv, "user-id", "password", dbname="dbhostnameorIP[:port]/dbservice")
source("connection.R")
```

Then we create the SQL query and get the data using dbGetQuery() function. 
```{r, eval=FALSE}
query <- paste0( "select obs.concept_cd, obs.tval_char, obs.nval_num, obs.units_cd , cd.name_char from observation_fact obs, sa_diag_mis_c_patients pat, concept_dimension cd where obs.patient_num = pat.patient_num and obs.concept_cd = cd.concept_cd and obs.start_date >= pat.admission_date and concept_cd in ('", labcodes, "')" )

internalDictionary <- DBI::dbGetQuery( con, query)
```

## Extract from the MUSIC dictionary the numeric laboratory values
First we read the dictionary to extract the laboratory information (extracted from Simran code). Then we select the variables for which we have a corresponding concept code in the pediatric database. Finally we restrict it to those having a numeric value. 

```{r}
datadict <- read.csv('../../common_ref/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv')

datadict_labonly <- datadict %>% 
  filter(Form.Name == "laboratory_values") %>%
  select( Variable...Field.Name, Form.Name, Choices..Calculations..OR.Slider.Labels, Field.Note,Text.Validation.Min, Text.Validation.Max, Text.Validation.Type.OR.Show.Slider.Number
          )

## subset for the concepts that we have a concept_cd
datadict_labonly <- datadict_labonly[ datadict_labonly$Variable...Field.Name %in% ecrftobch$Variable...Field.Name, ]

## numeric variables
num_lab_values <- datadict_labonly[ datadict_labonly$Text.Validation.Type.OR.Show.Slider.Number == "number",]
num_lab_values <- inner_join( num_lab_values, ecrftobch )
```

Then we extract the same subset of concepts from the pediatric database. 
```{r}
## BCH data dictionary
internalDictionary <- read.delim("lab_bch.dsv")
internalDictionary_numeric <- internalDictionary[ internalDictionary$CONCEPT_CD %in% num_lab_values$concept_cd, ]
```

We summarize the results from the pediatric database group by concept code (concept_cd), units (units_cd) and code description (name_char). For each one we extract the range (minimum and maximum values) and the units. This will enable us to do a first quality control, and guarantee that the concepts as we find them in the database is what are expected for the eCRF.

```{r}
internalDictionary_numericSummary <- internalDictionary_numeric %>%
  dplyr::group_by(CONCEPT_CD, UNITS_CD, NAME_CHAR) %>%
  dplyr::summarise( min = min(NVAL_NUM, na.rm = TRUE), max = max(NVAL_NUM, na.rm = TRUE)) %>%
  dplyr::select( CONCEPT_CD, min, max, UNITS_CD, NAME_CHAR)
colnames(internalDictionary_numericSummary) <- tolower(colnames(internalDictionary_numericSummary))
```

We create a final table merging both, the selected information from the MUSIC dictionary with the summary of the same values in the pediatric database. 

```{r}
## numeric lab values
final <- inner_join( internalDictionary_numericSummary, num_lab_values )
final <- final[, c("concept_cd", "concept_desc", "min", "max", "units_cd",
                   "Variable...Field.Name","Text.Validation.Min","Text.Validation.Max","Field.Note", "concept_path", "Form.Name")]
```

We remove the ones with units as "NOT DEFINED IN SOURCE" **we need to check those**
We observe that the are some units that even referring to the same appear in a different way in the MUSIC dictionary and in the database (e.g., "sec" and "seconds")
We create a new column, called "units_cd_transformed" and manually transform some of those based on a first review of the results. We create a new column to always be able to go back to the original information as is in the database. 

```{r}
# we have to check what these cases are: not defined in source
final <- final[ final$units_cd != "NOT DEFINED IN SOURCE",]
final$units_cd_transformed <- final$units_cd
final$units_cd_transformed <- gsub( "sec", "seconds", final$units_cd_transformed)
final$units_cd_transformed <- gsub( "cells/mcL", "Absolute cells/microliter", final$units_cd_transformed)
final$units_cd_transformed <- gsub( "unit/L", "U/L", final$units_cd_transformed)
final$units_cd_transformed <- gsub( "K cells/uL", "x10^3/uL or x10^9/L", final$units_cd_transformed)
final[ final$Field.Note =="x10^3/uL or 10^9/L", "Field.Note"] <- "x10^3/uL or x10^9/L"
```

After this transformation we check for which variables we still have different units, and for which variables the ranges in the database are out of the expected ranges as appear in the MUSIC dictionary.

```{r}
# check the units
final$checkUnits <- ifelse( final$units_cd_transformed ==  final$Field.Note, "OK", "To check")
```

```{r}
#Special cases
###triglycerids 1, mg/dL | 2, mmol/L | 3, Other; extracted from the excel but another column
final[ final$concept_desc == "Triglycerides" & final$Field.Note == "Specify units below", "Field.Note"] <- "1, mg/dL | 2, mmol/L | 3, Other"
final[ final$concept_desc == "Triglycerides", "checkUnits" ] <- ifelse( final[ final$concept_desc == "Triglycerides", "units_cd" ] %in% c("mg/dL","mmol/L","Other"), "OK", "To check")

###CRP 1, mg/L | 2, mg/dL | 3, Other; extracted from the excel but another column
final[ final$concept_desc == "C-Reactive Protein" & final$Field.Note == "Specify units below", "Field.Note"] <- "1, mg/L | 2, mg/dL | 3, Other"
final[ final$concept_desc == "C-Reactive Protein", "checkUnits" ] <- ifelse( final[ final$concept_desc == "C-Reactive Protein", "units_cd" ] %in% c("mg/L","mg/dL","Other"), "OK", "To check")
```

```{r}
# check the range when units correct
final$checkRange <- ifelse( final$checkUnits == "OK", ifelse(as.numeric(final$min) >= as.numeric(final$Text.Validation.Min) & as.numeric(final$max) <= as.numeric(final$Text.Validation.Max), "OK", "To check"), "To check")

head(as.data.frame(final))
```

Finally we generate a file with this mapping output for us to have as reference and further check disagreements. 

```{r}
# export as file
final <- final[, c("concept_cd", "concept_desc", "min", "max", "units_cd", "units_cd_transformed","Variable...Field.Name","Text.Validation.Min","Text.Validation.Max","Field.Note", "checkUnits", "checkRange","concept_path", "Form.Name")]
write.table(final, file = "numericlabsToReview.txt", col.names = TRUE, row.names = FALSE, sep = "\t", quote = FALSE)
```

### R session information

```{r}
sessionInfo()
```







