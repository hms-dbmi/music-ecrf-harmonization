---
title: "Create eCRF to LOINC Mapping Table"
author: "Simran Makwana"
date: "5/26/2021"
output: html_document
---
# Summary
We will use a semi-manual approach to create a mapping from the eCRF variables to the LOINC codes.
1. Load the necessary files: MUSIC data dictionary and UMLS database extract
2. For each variable prefix, identify a set of potential LOINC mappings. This is done by manually searching (grep) keywords from the eCRF variable in the STR description of the LOINC codes. **in progress**
3. Combine potential LOINC mappings into a single dataframe for review.
4. Potential check: determine how many identified LOINC mapping have corresponding entries in BCH. 

## Load the necessary packages and files
- data dictionary
- umls database extraction
```{r}
library(tidyverse)

datadict <- read.csv('../../common_ref/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv')
datadict_labonly <- datadict %>% 
  filter(Form.Name == 'laboratory_values') %>%
  mutate(prefix = gsub('_{1}[[:alnum:]]+$', '', Variable...Field.Name))

umls_loinc <- read.csv('../data/umls_loinc_db.csv')
umls_loinc <- umls_loinc %>%
  mutate(STR = gsub('[[:punct:]]', '', STR))
```

## Use GREP to identify potential mappings.
Try to focus the keywordsso that there are <100 results.
```{r}
potential_vars <- data.frame('SAB' = '',
                             'TTY' = '',
                             'CODE' = '',
                             'STR' = '',
                             'eCRF_var' = '')[-1,]

# ac4_cd8_ratio (Lymphocyte Subsets: CD4/CD8 ratio)
x <- umls_loinc[grep('cd4.*cd8|cd8.*cd4', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'ac4_cd8_ratio'), potential_vars)

# ah50 

# albumin

# alc (Absolute lymphocyte count)
x <- umls_loinc[grep('lymphocyte.*count', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'alc'), potential_vars)

# anc (Absolute neutrophil count)
umls_loinc[grep('neutrophil.*count', umls_loinc$STR, ignore.case = TRUE),]

# anti_sars_igg (Anti-SARS CoV-2 IgG)
x <- umls_loinc[grep('sars.*igg|igg.*sars', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'anti_sars_igg'), potential_vars)

x <- umls_loinc[grep('sars.*anti|anti.*sars', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'anti_sars_igg'), potential_vars)

# anti_sars_igm (Anti-SARS CoV-2 IgM)
x <- umls_loinc[grep('sars.*igm|igm.*sars', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'anti_sars_igm'), potential_vars)

x <- umls_loinc[grep('sars.*anti|anti.*sars', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'anti_sars_igm'), potential_vars)

# aptt_ptt (APTT or PTT (seconds))
x <- umls_loinc[grep('appt|ptt', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'aptt_ptt'), potential_vars)

# ast_sgot (AST/SGOT (U/L))
# aspartate aminotransferase AST test aka SGOT
x <- umls_loinc[grep('^ast ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'ast_sgot'), potential_vars)

x <- umls_loinc[grep('aspartate aminotransferase', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'ast_sgot'), potential_vars)

# ast_sgpt (ALT/SGPT (U/L))
# alanine aminotransferase ALT test aka AGPT
x <- umls_loinc[grep('alanine aminotransferase', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'ast_sgpt'), potential_vars)

# bicarbonate (Bicarbonate (mmol/L))
x <- umls_loinc[grep('bicarbonate', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'bicarbonate'), potential_vars)

# bnp (B-type natriuretic peptide (BNP) (pg/mL))
x <- umls_loinc[grep('natriuretic peptide', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'bnp'), potential_vars)

# c3 (Complement levels: C3 (mg/dL))
x <- umls_loinc[grep('complement.*c3.*massvolume', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'c3'), potential_vars)

# c4 (Complement levels: C4 (mg/dL))
x <- umls_loinc[grep('complement.*c4.*massvolume', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'c4'), potential_vars)

# cd19 (Lymphocyte Subsets: CD19+ (%))
x <- umls_loinc[grep('cd19 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd19'), potential_vars)

# cd19_abs (Lymphocyte Subsets: CD+19, Absolute)
x <- umls_loinc[grep('cd19 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd19_abs'), potential_vars)

# cd3 (Lymphocyte Subsets: CD3+ (%))
x <- umls_loinc[grep('cd3 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd3'), potential_vars)

# cd3_abs (Lymphocyte Subsets: CD3+, Absolute)
x <- umls_loinc[grep('cd3 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd3_abs'), potential_vars)

# cd3_cd16_cd56 (Lymphocyte Subsets: CD3-%/CD16+ or CD56+%)
x <- umls_loinc[grep('cd3cd16 |cd56 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd3_cd16_cd56'), potential_vars)

# cd3_cd4 (Lymphocyte Subsets: CD3+%/CD4+%)
x <- umls_loinc[grep('cd3cd4|cd4cd3 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd3_cd4'), potential_vars)

# cd3_cd4_abs (Lymphocyte Subsets: CD3+ CD4+, Absolute)
x <- umls_loinc[grep('cd3cd4|cd4cd3 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd3_cd4_abs'), potential_vars)

# cd3_cd8 (Lymphocyte Subsets: CD3+%/CD8+%)
x <- umls_loinc[grep('cd3cd8|cd8cd4 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd3_cd8'), potential_vars)

# cd3_cd8_abs (Lymphocyte Subsets: CD3+ CD8+, Absolute)
x <- umls_loinc[grep('cd3cd8|cd8cd4 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'cd3_cd8_abs'), potential_vars)

# ch50 (Complement levels: CH50 (%))
x <- umls_loinc[grep('ch50 ', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'ch50'), potential_vars)

# creatine_kin (Creatine kinase (U/L))
x <- umls_loinc[grep('creatinine.*kinase', umls_loinc$STR, ignore.case = TRUE),]
potential_vars <- rbind(x %>% mutate('eCRF_var' = 'creatine_kin'), potential_vars)

# creatinine

# crp (C-Reactive Protein, CRP (circle: mg/L or mg/dL)))

# cxcl9 (Cytokine panel: CXCL9 (pg/mL))

# d_dimer (D-dimer (mcg/mL FEU))

# direct_bilir (Direct bilirubin (mg/dL))

# esr (ESR (mm/hr))

# ferritin (Ferritin (ng/mL))

# fibrinogen (Fibrinogen (mg/dL))

# ggtp (Gamma-glutamyl transferase (GGT/GGTP) (U/L))

# glucose

# hematocrit (Hematocrit (%))

# hemoglobin

# ifn_gamma (Cytokine panel: IFN-gamma (pg/mL))

# iga

# ige

# igg

# igm

# il_1 (Cytokine panel: IL-1 (pg/mL))

# il_10 (Cytokine panel: IL-10 (pg/mL))

# il_12 (Cytokine panel: IL-12 (pg/mL))

# il_13 (Cytokine panel: IL-13 (pg/mL))

# il_17 (Cytokine panel: IL-17 (pg/mL))

# il_19 (Cytokine panel: IL-19 units)

# il_2 (Cytokine panel: IL-2 (pg/mL))

# il_2_receptor (Cytokine panel: IL-2 receptor soluble serum (pg/mL))

# il_4 (Cytokine panel: IL-4 (pg/mL))

# il_5 (Cytokine panel: IL-5 (pg/mL))

# il_6 (Cytokine panel: IL-6 (pg/mL))

# il_8 (Cytokine panel: IL-8 (pg/mL))

# inr (INR (units))

# lactate (Lactate (mmol/L))

# ldh (LDH (U/L))

# lymphocyt (Lymphocytes (%))

# neutrophil (Neutrophils (%))

# nl (Neutrophil/lymphocyte ratio)

# nt_probnp (NT-proBNP (pg/mL))

# platelets (Platelets (x10^3/uL or x10^9/L))

# potassium (Potassium (mmol/L))

# procalcit (Procalcitonin (ng/mL))

# pt_seconds (PT (seconds))

# sars_cov2_antig (SARS-CoV-2 antigen)

# sars_cov2ntpcr (SARS CoV-2 NT PCR)

# sodium (Sodium (mmol/L))

# t_sum (Lymphocyte Subsets: %T-sum)

# thrombin_tm (Thrombin time (seconds))

# tnf_alpha (Cytokine panel: TNF-alpha (pg/mL))

# total_anti (Total Antibody)

# total_bilir (Total bilirubin (mg/dL))

# total_protein (Total protein (g/dL))

# triglycerid (Triglycerides (circle: mg/dL or mmol/L))

# troponin_l (Troponin I (ng/mL))

# troponin_t (Troponin T (ng/mL))

# urea (Urea (BUN) (mg/dL))

# wbc (WBC Count (x10^3/uL or 10^9/L))



```




