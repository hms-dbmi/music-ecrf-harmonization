---
title: 'Lab Values Example: Data ETL'
author: "Simran Makwana"
date: "5/4/2021"
output: html_document
---

*derived from `music_lab_Values.R`*

Use a modification of the following query to extract the data based on concepts in labDictionary.txt:
*Query has been previously run and saved*

source("connection.R")
dbGetQuery( con, paste0("select obs.patient_num, obs.concept_cd, obs.start_date, obs.tval_char, 
  obs.nval_num, obs.units_cd, pat.admission_date, pat.discharge_date 
  from observation_fact obs, 
  sa_diag_mis_c_patients pat 
  where obs.patient_num = pat.patient_num and 
  obs.concept_cd in ('", concepts, "') and 
  obs.start_date >= pat.admission_date" )) 
  
```{r}
library(tidyverse)
library(lubridate)
lab_dictionary <- read.delim("../data/labDictionary.txt", header = TRUE, sep = ' ')


```
                                   
Import test data with randomized patient ids
```{r}
subset_df <- read.csv('../local_ref/testoutput.csv')
#subset_df$PATIENT_NUM <- floor(runif(nrow(subset_df))*100)
#write.csv(subset_df, '../local_ref/testoutput.csv', row.names = FALSE)

```

Data transformation
- split `START_DATE` field into `date` and `time`
- perform a left join to combine extracted data with variables in lab dictionary
- reformat `ADMISSION_DATE` and `DISCHARGE_DATE` as dates
- calculate `days_after_admission` and `days_after_discharge`
```{r}
subset_df$date <- sapply(strsplit( as.character(subset_df$START_DATE), " "), '[', 1)
subset_df$time <- sapply(strsplit( as.character(subset_df$START_DATE), " "), '[', 2)

finalTable <- left_join( subset_df, lab_dictionary, by = c("CONCEPT_CD" = "concept_cd") )

finalTable <- finalTable %>%
  mutate(date = mdy(as.character(dmy(date), format = "%m-%d-%Y")),
         ADMISSION_DATE = mdy(as.character(dmy(ADMISSION_DATE), format = "%m-%d-%Y")),
         DISCHARGE_DATE = mdy(as.character(dmy(DISCHARGE_DATE), format = "%m-%d-%Y")),
         days_after_admission = date - ADMISSION_DATE,
         days_after_discharge = date - DISCHARGE_DATE)

```

Extract `value` based on type of variable
- focus on `_date`, `_value`, `_unit`, and `_obtained` variables (identified as most prevalent in `data_dictionary_extraction.Rmd`)
  - choices accepted for `obtained` variables: 1, 0
  - choices accepted for `value` variables: no criteria. if NVAL_NUM is not NA, then NVAL_NUM. else TVAL_CHAR
  - choices accepted for `unit` variables: no criteria. use UNITS_CD column
  - choices accepted for `date` variables: use date column in mdy format
```{r}
# Create function to extract value
getLabValue <- function(row) {
  
  # for obtained variables, if the entry is present, the 'value' is automatically 1
  if (row['vartype'] == 'obtained') {
    value = 1
    
  # All units will be ‘-88’ because in phase 1, we are only including variables where the unit listed below the Value field was used. 
  } else if (row['vartype'] == 'unit') {
    value = -88
    
  # for date variables, use the date column
  } else if (row['vartype'] == 'date') {
    value = as.character(ymd(row['date']), format = "%m-%d-%Y")
    
  # for value variables, if NVAL_NUM is not NA, use NVAL_NUM. else use TVAL_CHAR
  } else if (row['vartype'] == 'value') {
    if(!is.na(row['NVAL_NUM'])){
      value = row['NVAL_NUM']
    } else {
      value = row['TVAL_CHAR']
    }
  }
    
  # for other variables, mark as 'UNKNOWN' and investigate; there should not be any of these for now
  else {
    value = 'UNKNOWN'
  }
   
}

```

```{r}
finalTable <- finalTable %>%
  
  # categorize the variable types
  mutate(vartype = gsub("^.*_", "", variableName)) %>%

  # remove entries with no data
  filter(!is.na(NVAL_NUM) | TVAL_CHAR != '') %>%

  # remove duplicated rows
  distinct
         
finalTable$value <- apply(finalTable, 1, FUN = getLabValue)

finalTable

```

lab_values_visit
1, Admission/first obtained during MIS-C hospitalization
2, Closest to discharge during MIS-C hospitalization
3, 2 Weeks Post Discharge
4, 6 Weeks Post Discharge
6, 6 Months Post Discharge
25, Hospital readmission within 6 months of initial hospital discharge **Note** : need to clairfy in vs out patient
23, 'Worst Values During Hosp' **Note**: waiting to hear back about 'worst' values. For now, taking **max** of all labs.
```{r}
finalTable

# 1, Admission/first obtained during MIS-C hospitalization
group_1 <- finalTable %>% 
  group_by(PATIENT_NUM, variableName) %>%
  filter(START_DATE == min(START_DATE)) %>%
  mutate(lab_values_visit_discrepancy =  as_date(0) - as_date(0)) %>%
  mutate(lab_values_visit = 1)

# 2, Closest to discharge during MIS-C hospitalization
group_2 <- finalTable %>% 
  group_by(PATIENT_NUM, variableName) %>%
  filter(date >= (ADMISSION_DATE),
         date <= (DISCHARGE_DATE)) %>% #start date must be within hospitalization
  filter(days_after_discharge == max(days_after_discharge)) %>%
  mutate(lab_values_visit_discrepancy = days_after_discharge) %>%
  mutate(lab_values_visit = 2)

# 3, 2 Weeks Post Discharge
group_3 <- finalTable %>% 
  group_by(PATIENT_NUM, variableName) %>%
  mutate(lab_values_visit_discrepancy = days_after_discharge - 14) %>%
  filter(lab_values_visit_discrepancy == min(abs(lab_values_visit_discrepancy))) %>% # use date closest to 2 weeks post discharge
  mutate(lab_values_visit = 3)

#4, 6 Weeks Post Discharge
group_4 <- finalTable %>% 
  group_by(PATIENT_NUM, variableName) %>%
  mutate(lab_values_visit_discrepancy = days_after_discharge - 42) %>%
  filter(lab_values_visit_discrepancy == min(abs(lab_values_visit_discrepancy))) %>% # use date closest to 6 weeks post discharge
  mutate(lab_values_visit = 4)

# 6, 6 Months Post Discharge
group_6 <- finalTable %>% 
  group_by(PATIENT_NUM, variableName) %>%
  mutate(lab_values_visit_discrepancy = days_after_discharge - 182) %>%
  filter(lab_values_visit_discrepancy == min(abs(lab_values_visit_discrepancy))) %>% # use date closest to 6 months post discharge
  mutate(lab_values_visit = 6)

# 25, Hospital readmission within 6 months of initial hospital discharge 
#group_25 <- finalTable %>%
#  group_by(PATIENT_NUM, variableName) %>%
#  mutate(initial_discharge = min(DISCHARGE_DATE)) %>%
#  filter(date > initial_discharge) %>%
#  mutate(lab_values_visit = 25)

# 23, 'Worst Values During Hosp' **Note**: waiting to hear back about 'worst' values. For now, taking **max** of all labs.
group_23 <- finalTable %>% 
  group_by(PATIENT_NUM, variableName) %>%
  mutate(value = as.numeric(value)) %>%
  filter(vartype == 'value',
         value == max(value, na.rm = TRUE)) %>%
  mutate(lab_values_visit = 23,
         value = as.character(value))


combinedFinal <- bind_rows(group_1, group_2, group_3, group_4, group_6, group_23) # currently not including group 25

```

redcap_repeat_instance
- Using dates to determine visit number **uncertain about meaning of redcap_repeat_instance and lab_values_visit**
- note that entries inputted at different times on the same date are considered as separate events / visits


```{r}
combinedFinal <- combinedFinal %>% 
  group_by(PATIENT_NUM, date, time) %>%
  arrange(date, time) %>%
  mutate(redcap_repeat_instance = cur_group_id()) %>%
  arrange(redcap_repeat_instance)

combinedFinal %>% select(PATIENT_NUM, date, time, redcap_repeat_instance) 

```


Pivot table wider and make compatible with RedCap formatting
**Incorporate visit column, which may represent redcap_repeat_instance or lab_values_visit**
```{r}

out <- pivot_wider(combinedFinal, 
                   id_cols = c(PATIENT_NUM, formName, date, time, lab_values_visit, lab_values_visit_discrepancy, redcap_repeat_instance), 
                   names_from = variableName, 
                   values_from = value, 
                   values_fill = '')

# should we remove entries with no data?
#finalTable %>% filter(is.na(NVAL_NUM), TVAL_CHAR == '')


# Rename columns for redcap
out <- out %>%
  rename('record_id' = 'PATIENT_NUM',
         'redcap_repeat_instrument' = 'formName') %>%
  mutate(redcap_data_access_group = "120_boston_childe",
         redcap_event_name = "repeating_forms_arm_1") %>%
  relocate(record_id, redcap_event_name, redcap_repeat_instrument, redcap_repeat_instance, redcap_data_access_group, lab_values_visit)

write.csv(out, '../local_ref/redcap_output.csv', row.names = FALSE)
```















