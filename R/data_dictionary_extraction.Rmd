---
title: "Extract Info From Data Dictionary"
author: "Simran Makwana"
date: "5/3/2021"
output: html_document
---

# Begin with Exploring the entire Lab Values Data Dictionary
```{r setup, include=FALSE}
library(tidyverse)
```

Load data
```{r}
datadict <- read.csv('../data/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv')
checked_vars <- read.csv('../data/numericalLabsToReview.csv', header = FALSE) 
colnames(checked_vars) <- checked_vars[2,]
checked_vars <- checked_vars[-c(1,2),]

```

Focus on values which have passed both the checkUnits and the checkRange filters
```{r}
var_prefixes <- checked_vars %>% 
  filter(checkUnits == 'OK', 
         checkRange == 'OK') %>%
  pull(Variable...Field.Name) 

var_prefixes <- gsub('_value', '', var_prefixes)

# focusing on these 4 types of variables first
our_vars <- c(paste0(var_prefixes, '_obtained'), 
              paste0(var_prefixes, '_value'),
              paste0(var_prefixes, '_unit'),
              paste0(var_prefixes, '_date'))

  
```

Focus on laboratory values in data dictionary
- combine the "Choices..." column with the "Field.Note" column, as they contain similar info
```{r}
datadict_labonly <- datadict %>% 
  filter(Form.Name == "laboratory_values") %>%
  mutate(Choices..Calculations..OR.Slider.Labels = paste0(Choices..Calculations..OR.Slider.Labels, Field.Note))

datadict_labonly

```

Sort into variable types (lookint at whole data dictionary)
The table below shows the frequency of various variable type found in the laboratory values eCRF.
As expected, 'date', 'value', and 'obtained' are the most prevalent, with unit being very prevalent as well. 
We will focus on these 4 types of variables first.
```{r}

datadict_labonly <- datadict_labonly %>%
  mutate(vartype = gsub("^.*_", "", Variable...Field.Name)) 

datadict_labonly %>%
  select(Variable...Field.Name, vartype) %>%
  group_by(vartype) %>%
  summarise(n_vars = n()) %>%
  arrange(desc(n_vars))


```
For 'obtained', we want to know what choices are expected by redcap for each variable in this category.
The below table shows that the majority of 'obtained' variables have the boolean response 1 (yes) or 0 (no). 
We will focus on the variables with yes/no response only for now.
```{r}
datadict_labonly %>%
  filter(vartype == 'obtained') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n())

remove_vars <- datadict_labonly %>% 
  filter(vartype == 'obtained', Choices..Calculations..OR.Slider.Labels != '1, Yes | 0, No') %>% 
  pull(Variable...Field.Name)
remove_prefixes <- gsub('_obtained', '', remove_vars)


```
For 'value', we want to know what choices are expected by redcap for each variable in this category.
**use column "H" in data dict to verify if numeric etc**

There are several different specifications for the units in which values are provided.
Variables for which the expected value matches the ‘UNITS_CD’ entry in BCH will be included.
These variables have already been filtered for when focusing on values which have passed both the checkUnits and the checkRange filters.
```{r}
datadict_labonly %>%
  filter(vartype == 'value') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n()) %>% 
  arrange(desc(n_vars))


```

Dates are requested in ‘mm-dd-yyyy’ format.
We will include all 'date' variables for now.
```{r}
datadict_labonly %>%
  filter(vartype == 'date') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n())

```


Unit variables rely on value variables.
In phase 1, we are only including variables where the unit listed below the Value field was used. 
These variables have already been filtered for when focusing on values which have passed both the checkUnits and the checkRange filters.
All units will be ‘-88’.
```{r}
datadict_labonly %>%
  filter(vartype == 'unit') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n()) %>%
  arrange(desc(n_vars))


```

We will now select all variables which are associated with the numeric laboratory variables we filtered for previously.
Remove any variables that were filtered out when examining obtained, unit, or date variables.
```{r}
remove_vars <- c(paste0(remove_prefixes, '_obtained'), 
              paste0(remove_prefixes, '_value'),
              paste0(remove_prefixes, '_unit'),
              paste0(remove_prefixes, '_date'))

our_vars <- our_vars[!our_vars %in% remove_vars]

```

Let's view the summaries for the selected variables.
```{r}
datadict_labonly %>% 
  filter(Variable...Field.Name %in% our_vars) %>% 
  pull(vartype) %>%
  table()

datadict_labonly %>% 
  filter(Variable...Field.Name %in% our_vars,
         vartype == 'date') %>%
  pull(Choices..Calculations..OR.Slider.Labels) %>%
  table()

datadict_labonly %>% 
  filter(Variable...Field.Name %in% our_vars,
         vartype == 'value') %>%
  pull(Choices..Calculations..OR.Slider.Labels) %>%
  table()

datadict_labonly %>% 
  filter(Variable...Field.Name %in% our_vars,
         vartype == 'unit') %>%
  pull(Choices..Calculations..OR.Slider.Labels) %>%
  table()

datadict_labonly %>% 
  filter(Variable...Field.Name %in% our_vars,
         vartype == 'obtained') %>%
  pull(Choices..Calculations..OR.Slider.Labels) %>%
  table()



```


We now have our 'phase 1 variables', which we can reasonably map reported value in the EHR to expected value in RedCap.
We can map these variable names to their associated concept_cds using the manually generated 'eCRF to BCH mapping' file and create the corresponding `labDictionary` file.
For now, we will ignore the variables which we do not have concept codes for.
Then we can use these concept_CD values to query the BCH database.
After querying the database, a separate script will map values from the query response to the expected values found in this notebook.
```{r}
#our_vars

mapping <- read.csv('../data/eCRF to BCH mapping.csv') %>%
  filter(Form.Name == 'laboratory_values')

labdict <- left_join(as.data.frame(our_vars), mapping, by = c('our_vars' = 'Variable...Field.Name')) %>%
  rename(variableName = our_vars,
         formName = Form.Name) %>%
  select(variableName, concept_cd, formName) %>%
  
  # For now, we will ignore the variables which we do not have concept codes for.
  filter(concept_cd != '')


```

Save labdict as `labdictionary.txt` for use in other notebooks.
```{r}
write.table(labdict, '../data/labDictionary.txt', quote = FALSE, row.name = FALSE)

# for manual SQL query:
write.table(labdict$concept_cd, '../local_ref/concepts_for_query.txt', row.names = FALSE, col.names = FALSE, eol = "', '", quote = FALSE)

```







