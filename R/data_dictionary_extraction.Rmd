---
title: "Extract Info From Data Dictionary"
author: "Simran Makwana"
date: "5/3/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

Load data
```{r}
datadict <- read.csv('../data/MUSIC_DataDictionary_V3_4Dec20_final version_clean_0.csv')

our_vars <- c()
```

Focus on laboratory values
```{r}
datadict_labonly <- datadict %>% 
  filter(Form.Name == "laboratory_values")

datadict_labonly

```

Sort into variable types
The table below shows the frequency of various variable type found in the laboratory values eCRF.
As expected, 'date', 'value', and 'obtained' are the most prevalent, with unit being very prevalent as well. 
We will focus on these 4 types of variables first.
```{r}

datadict_labonly <- datadict_labonly %>%
  mutate(vartype = gsub("^.*_", "", Variable...Field.Name)) 

datadict_labonly %>%
  select(Variable...Field.Name, vartype) %>%
  group_by(vartype) %>%
  summarise(n_vars = n()) %>%
  arrange(desc(n_vars))


```
For 'obtained', we want to know what choices are expected by redcap for each variable in this category.
The below table shows that the majority of 'obtained' variables have the boolean response 1 (yes) or 0 (no). 
We will focus on the variabls with yes/no response only for now.
```{r}
datadict_labonly %>%
  filter(vartype == 'obtained') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n())

our_vars <- c(our_vars, datadict_labonly %>% filter(vartype == 'obtained', Choices..Calculations..OR.Slider.Labels == '1, Yes | 0, No') %>% pull(Variable...Field.Name))

```
For 'value', we want to know what choices are expected by redcap for each variable in this category.
**use column "H" in data dict to verify if numeric etc**

The below table shows that the majority of 'value' variables have no specified response. 
We will assume that this means whatever value is listed in the BCH database can be directly reported to RedCap.
We will focus on these variables for now.
```{r}
datadict_labonly %>%
  filter(vartype == 'value') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n())

our_vars <- c(our_vars, datadict_labonly %>% filter(vartype == 'value', Choices..Calculations..OR.Slider.Labels == '') %>% pull(Variable...Field.Name))

```

For 'date', we want to know what choices are expected by redcap for each variable in this category.
The below table shows that none of the 'date' variables have any specified response. 
**We will report this data in 'MDY' format**
We will include all 'date' variables for now.
```{r}
datadict_labonly %>%
  filter(vartype == 'date') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n())

our_vars <- c(our_vars, datadict_labonly %>% filter(vartype == 'date') %>% pull(Variable...Field.Name))

```


For 'unit', we want to know what choices are expected by redcap for each variable in this category.
The below table shows that the majority of 'unit' variables have no specified response. 
We will assume that this means that for these variables, whatever value is listed in the BCH database under 'UNITS_CD' can be directly reported to RedCap.
We will focus on the 'unit' variables with unspecified responses for now.
```{r}
datadict_labonly %>%
  filter(vartype == 'unit') %>%
  group_by(Choices..Calculations..OR.Slider.Labels) %>%
  summarise(n_vars = n())

our_vars <- c(our_vars, datadict_labonly %>% filter(vartype == 'unit', Choices..Calculations..OR.Slider.Labels == '') %>% pull(Variable...Field.Name))

```

We now have a set of variables for we can reasonably map reported value in the EHR to expected value in RedCap.
We can map these variable names to their associated concept_cds using the manually generated 'eCRF to BCH mapping' file and create the corresponding `labDictionary` file.
For now, we will ignore the variables which we do not have concept codes for.
Then we can use these concept_CD values to query the BCH database.
After querying the database, a separate script will map values from the query response to the expected values found in this notebook.
```{r}
#our_vars

mapping <- read.csv('eCRF to BCH mapping.csv') %>%
  filter(Form.Name == 'laboratory_values')

labdict <- left_join(as.data.frame(our_vars), mapping, by = c('our_vars' = 'Variable...Field.Name')) %>%
  rename(variableName = our_vars,
         formName = Form.Name) %>%
  select(variableName, concept_cd, formName) %>%
  
  # For now, we will ignore the variables which we do not have concept codes for.
  filter(concept_cd != '')



```

Save labdict as `labdictionary.txt` for use in other notebooks.
```{r}
write.table(labdict, 'labDictionary.txt', quote = FALSE, row.name = FALSE)

write.table(labdict$concept_cd, 'test.txt', row.names = FALSE, col.names = FALSE, eol = "', '", quote = FALSE)

```







